<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background-color: #f4f4f4;
      padding: 20px;
    }
    body.dark-mode {
  background-color: #1e1e1e;
  color: #f0f0f0;
}
body.dark-mode .container {
  background-color: #2c2c2c;
}
body.dark-mode input,
body.dark-mode select {
  background-color: #444;
  color: white;
  border: 1px solid #777;
}
body.dark-mode button {
  opacity: 1;
}
body.dark-mode .number-list {
  background-color: #333;
  color: #fff;
}

    .container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      display: inline-block;
    }
    input, button, select {
      padding: 10px;
      margin: 5px;
      font-size: 16px;
    }
    button {
      border: none;
      border-radius: 5px;
      cursor: pointer;
      color: white;
    }
    .generate-butt{
      background-color: #0763c6;
    }
    .export-butt{
      background-color: darkslategray;
    }
    .history-butt {
      background-color: #6a5acd;
    }
    .call-button { background-color: #28a745; }
    .bad-button { background-color: #dc3545; }
    .alive-button { background-color: #ffc107; color: black; }
    .filter-button { background-color: #007bff; }
    .reset-button { background-color: #6c757d; }
    button:hover { opacity: 0.9; }
    .phone-list {
      margin-top: 20px;
      text-align: left;
    }
    .phone-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px 0;
      border-bottom: 1px solid #ddd;
    }
    .phone-item .number {
      text-align: left;
      flex-grow: 1;
    }
    .phone-item .buttons {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    .called span::before {
      content: "\2714\0020";
      color: green;
    }
    .bad-number span { color: red; }
    .alive-number span::after {
      content: " (–∂–∏–≤–æ–π)";
      color: green;
      font-weight: bold;
    }
    .number-list {
      margin-top: 20px;
      background: #fff;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
      white-space: pre-line;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <button id="themeToggle" style="position:absolute; top:20px; right:20px; padding:10px; border:none; background:#333; color:white; border-radius:5px; cursor:pointer;">
    üåô –¢–µ–º–∞
  </button>
  
  <div class="container">
    <h2>–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤</h2>

    <label for="prefix">–ü—Ä–µ—Ñ–∏–∫—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, 7495):</label>
    <input type="text" id="prefix" placeholder="7495" />

    <label for="customCount">–ö–æ–ª-–≤–æ –Ω–æ–º–µ—Ä–æ–≤ (–¥–æ 999):</label>
    <input type="number" id="customCount" min="1" max="999" placeholder="20" />

    <button class="generate-butt" onclick="generatePhoneNumbers(document.getElementById('customCount').value)">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
    <br />

    <button class="generate-butt" onclick="generatePhoneNumbers(1)">1 –Ω–æ–º–µ—Ä</button>
    <button class="generate-butt" onclick="generatePhoneNumbers(5)">5 –Ω–æ–º–µ—Ä–æ–≤</button>
    <button class="generate-butt" onclick="generatePhoneNumbers(10)">10 –Ω–æ–º–µ—Ä–æ–≤</button>
    <br />
    
    <label for="uploadTxt"> –ó–∞–≥—Ä—É–∑–∏—Ç—å .txt
      <input type="file" id="uploadTxt" name="uploadTxt" accept=".txt" onchange="loadFromTxt()" />
    </label>
    <button class="export-butt" onclick="exportToExcel()">–≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
    <button class="export-butt" onclick="exportToTxt()">–≠–∫—Å–ø–æ—Ä—Ç –≤ TXT</button>
    <button class="history-butt" onclick="showAllHistoryNumbers()">–í—Å—è –∏—Å—Ç–æ—Ä–∏—è –Ω–æ–º–µ—Ä–æ–≤</button>
    <button class="export-butt" onclick="clearCallHistory()">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>

    <h4>–§–∏–ª—å—Ç—Ä—ã:</h4>
    <button class="filter-button" onclick="filterNumbers('all')">–í—Å–µ</button>
    <button class="filter-button" onclick="filterNumbers('alive')">–ñ–∏–≤—ã–µ</button>
    <button class="filter-button" onclick="filterNumbers('bad')">–ù–µ —Ä–∞–±–æ—á–∏–µ</button>
    <button class="filter-button" onclick="filterNumbers('uncalled')">–ë–µ–∑ –∑–≤–æ–Ω–∫–∞</button>

    <h3>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞:</h3>
    <div id="phoneList" class="phone-list"></div>

    <h3>–°–ø–∏—Å–æ–∫ –Ω–æ–º–µ—Ä–æ–≤:</h3>
    <div id="numberList" class="number-list"></div>
  </div>

  <script src="https://cdn.sheetjs.com/xlsx-0.18.5/package/dist/xlsx.full.min.js"></script>
  <script>
    document.getElementById("themeToggle").addEventListener("click", () => {
  document.body.classList.toggle("dark-mode");
  localStorage.setItem("theme", document.body.classList.contains("dark-mode") ? "dark" : "light");
});

window.addEventListener("DOMContentLoaded", () => {
  if (localStorage.getItem("theme") === "dark") {
    document.body.classList.add("dark-mode");
  }
});

    let allNumbers = [];
    const HISTORY_KEY = "phoneNumberHistory";

    function loadStatus() {
      try {
        return JSON.parse(localStorage.getItem("numberStatus")) || {};
      } catch {
        return {};
      }
    }

    function saveStatus(status) {
      localStorage.setItem("numberStatus", JSON.stringify(status));
    }

    function saveToHistory(numbers) {
      let history = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞, –∏—Å–∫–ª—é—á–∞—è –¥—É–±–ª–∏–∫–∞—Ç—ã
      numbers.forEach(num => {
        if (!history.includes(num)) {
          history.push(num);
        }
      });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function loadHistory() {
      try {
        return JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
      } catch {
        return [];
      }
    }

    function updateStatus(number, state) {
      const status = loadStatus();
      status[number] = state;
      saveStatus(status);
      renderList(allNumbers);
    }

    function generatePhoneNumbers(count) {
      const prefix = document.getElementById("prefix").value.trim();
      const quantity = parseInt(count);
      if (!prefix.startsWith("7") || prefix.length > 10) {
        alert("–ü—Ä–µ—Ñ–∏–∫—Å –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å '7' –∏ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –º–∞–∫—Å–∏–º—É–º 10 —Ü–∏—Ñ—Ä.");
        return;
      }
      if (isNaN(quantity) || quantity < 1 || quantity > 999) {
        alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–º–µ—Ä–æ–≤ (1‚Äì999).");
        return;
      }

      const missingDigits = 11 - prefix.length;
      const newNumbers = [];
      for (let i = 0; i < quantity; i++) {
        const rand = Math.floor(Math.pow(10, missingDigits - 1) + Math.random() * 9 * Math.pow(10, missingDigits - 1));
        const fullNum = prefix + rand;
        newNumbers.push(fullNum);
      }
      allNumbers = newNumbers;
      saveToHistory(newNumbers);
      renderList(newNumbers);
    }

    function showAllHistoryNumbers() {
      const historyNumbers = loadHistory();
      if (historyNumbers.length === 0) {
        alert("–ò—Å—Ç–æ—Ä–∏—è –Ω–æ–º–µ—Ä–æ–≤ –ø—É—Å—Ç–∞.");
        return;
      }
      
      // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –≤—Å–µ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –Ω–æ–º–µ—Ä–∞
      allNumbers = historyNumbers;
      renderList(historyNumbers, 'all');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–æ–º–µ—Ä–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏–∏
      alert(`–í—Å–µ–≥–æ –≤ –∏—Å—Ç–æ—Ä–∏–∏: ${historyNumbers.length} –Ω–æ–º–µ—Ä–æ–≤`);
    }

    function renderList(numbers, filter = 'all') {
      const phoneList = document.getElementById("phoneList");
      const numberList = document.getElementById("numberList");
      phoneList.innerHTML = "";
      numberList.innerText = "";

      const status = loadStatus();
      const lines = [];

      numbers.forEach(num => {
        const s = status[num] || 'uncalled';
        if (filter !== 'all' && s !== filter) return;

        const div = document.createElement("div");
        div.className = `phone-item ${s === 'called' ? 'called' : s === 'bad' ? 'bad-number' : s === 'alive' ? 'alive-number' : ''}`;
        
        div.innerHTML = `
          <div class="number">
            <span>${num}</span>
          </div>
          <div class="buttons">
            <button class="call-button" onclick="callNumber('${num}')">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
            <button class="bad-button" onclick="updateStatus('${num}', 'bad')">–ù–µ —Ä–∞–±–æ—á–∏–π</button>
            <button class="alive-button" onclick="updateStatus('${num}', 'alive')">–ù–µ –≤–∑—è–ª</button>
          </div>
        `;
        
        phoneList.appendChild(div);

        let label = "";
        if (s === "bad") label = " (–Ω–µ—Ä–∞–±–æ—á–∏–π)";
        if (s === "alive") label = " (–∂–∏–≤–æ–π)";
        lines.push(num + label);
      });

      numberList.innerText = lines.join("\n");
    }

    function callNumber(number) {
      try {
        const link = document.createElement("a");
        link.href = "sip:" + number;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (e) {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ SIP-–∑–≤–æ–Ω–∫–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ MicroSIP —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.");
      }
      updateStatus(number, "called");
    }

    function clearCallHistory() {
      if (confirm("–£–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ (–Ω–æ–º–µ—Ä–∞, —Å—Ç–∞—Ç—É—Å—ã, –∏—Å—Ç–æ—Ä–∏—é)?")) {
        localStorage.removeItem("numberStatus");
        localStorage.removeItem(HISTORY_KEY);
        allNumbers = [];
        document.getElementById("phoneList").innerHTML = "";
        document.getElementById("numberList").innerText = "";
      }
    }

    function filterNumbers(state) {
      renderList(allNumbers, state);
    }

    function exportToExcel() {
      if (typeof XLSX === 'undefined') {
          alert("–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
          return;
      }

      if (allNumbers.length === 0) {
          alert("–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
          return;
      }

      const status = loadStatus();
      const data = allNumbers.map(num => ({
          "–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞": num,
          "–°—Ç–∞—Ç—É—Å": status[num] === 'called' ? '–ü–æ–∑–≤–æ–Ω–∏–ª–∏' : 
                   status[num] === 'bad' ? '–ù–µ —Ä–∞–±–æ—á–∏–π' : 
                   status[num] === 'alive' ? '–ñ–∏–≤–æ–π' : '–ù–µ –∑–≤–æ–Ω–∏–ª–∏'
      }));

      try {
          const worksheet = XLSX.utils.json_to_sheet(data);
          const workbook = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(workbook, worksheet, "–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–µ –Ω–æ–º–µ—Ä–∞");
          XLSX.writeFile(workbook, "—Ç–µ–ª–µ—Ñ–æ–Ω–Ω—ã–µ_–Ω–æ–º–µ—Ä–∞.xlsx");
      } catch (error) {
          console.error("–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:", error);
          alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ: " + error.message);
      }
    }

    function exportToTxt() {
      const status = loadStatus();
      const phoneItems = document.querySelectorAll(".phone-item span");
      const lines = [];

      phoneItems.forEach(span => {
        const number = span.textContent.replace(/\s*\(.*?\)\s*/g, '').trim();
        let label = "";

        if (span.closest('.bad-number')) {
          label = " (–Ω–µ—Ä–∞–±–æ—á–∏–π)";
        } else if (span.closest('.alive-number')) {
          label = " (–∂–∏–≤–æ–π)";
        } else if (span.closest('.called')) {
          label = " (–∑–≤–æ–Ω–∏–ª–∏)";
        }

        lines.push(`${number}${label}`);
      });

      if (lines.length === 0) {
        alert("–ù–µ—Ç –Ω–æ–º–µ—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞.");
        return;
      }

      const blob = new Blob([lines.join("\n")], { type: "text/plain;charset=utf-8" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "–Ω–æ–º–µ—Ä–∞.txt";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function loadFromTxt() {
      const fileInput = document.getElementById("uploadTxt");
      const file = fileInput.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        const text = e.target.result;
        const lines = text.split(/\r?\n/).map(line => line.trim()).filter(Boolean);
        const filtered = lines.filter(line => /^7\d{10}$/.test(line));
        allNumbers = filtered;
        saveToHistory(filtered);
        renderList(filtered);
      };
      reader.readAsText(file);
    }
  </script>
</body>
</html>